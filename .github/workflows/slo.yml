name: SLO

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      github_pull_request_number:
        description: "Pull request number (optional)"
        required: false
      baseline_ref:
        description: "Baseline commit/branch/tag to compare against (leave empty to auto-detect merge-base with main)"
        required: false

jobs:
  ydb-slo-pre:
    if: (!contains(github.event.pull_request.labels.*.name, 'no slo'))

    name: Generate SLO Pre-Summary
    runs-on: ubuntu-latest

    steps:
      - run: |
          echo "# ðŸŒ‹ SLO Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  ydb-slo-test:
    if: (!contains(github.event.pull_request.labels.*.name, 'no slo'))

    name: Run YDB SLO Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        workload:
          - sync-table
          - sync-query

    concurrency:
      group: slo-${{ github.ref }}-${{ matrix.workload }}
      cancel-in-progress: true

    steps:
      - name: Checkout current version
        uses: actions/checkout@v6
        with:
          path: current
          fetch-depth: 0

      - name: Determine baseline commit
        id: baseline
        run: |
          cd current

          # If baseline_ref is provided, use it
          # Otherwise, find the merge base with main
          if [[ -n "${{ inputs.baseline_ref }}" ]]; then
            BASELINE="${{ inputs.baseline_ref }}"
          else
            BASELINE=$(git merge-base HEAD origin/main)
          fi

          echo "sha=$BASELINE" >> $GITHUB_OUTPUT

      - name: Checkout baseline version
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.baseline.outputs.sha }}
          path: baseline
          fetch-depth: 1

      - name: Initialize YDB SLO
        uses: ydb-platform/ydb-slo-action/init@main
        with:
          github_issue: ${{ github.event.inputs.github_pull_request_number }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workload_name: ${{ matrix.workload }}

      - name: Build workload images
        run: |
          # Build current version
          if [ -f "$GITHUB_WORKSPACE/current/deploy/app/Dockerfile" ]; then
            echo "Building current app image..."
            cd "$GITHUB_WORKSPACE/current/deploy"
            docker build -t ydb-app-current ./app
          else
            echo "No current app Dockerfile found"
          fi

          # Build baseline version
          if [ -f "$GITHUB_WORKSPACE/baseline/deploy/app/Dockerfile" ]; then
            echo "Building baseline app image..."
            cd "$GITHUB_WORKSPACE/baseline/deploy"
            docker build -t ydb-app-baseline ./app
          else
            echo "No baseline app Dockerfile found"
          fi

      - name: Prepare SLO Database
        run: |
          echo "Preparing SLO database..."

      - name: Run SLO Tests (parallel)
        timeout-minutes: 15
        run: |
          set -e

          DURATION=600  # 10 minutes

          # Start current workload container
          if docker image inspect ydb-app-current >/dev/null 2>&1; then
            echo "Starting ydb-app-current..."
            docker run -d \
              --name ydb-app-current \
              --network ydb_ydb-net \
              --add-host "ydb:172.28.0.11" \
              --add-host "ydb:172.28.0.12" \
              --add-host "ydb:172.28.0.13" \
              --add-host "ydb:172.28.0.99" \
              -e CHECK_INTERVAL=5 \
              -e DURATION=${DURATION} \
              ydb-app-current
          else
            echo "No current app image found, skipping..."
          fi

          # Start baseline workload container
          if docker image inspect ydb-app-baseline >/dev/null 2>&1; then
            echo "Starting ydb-app-baseline..."
            docker run -d \
              --name ydb-app-baseline \
              --network ydb_ydb-net \
              --add-host "ydb:172.28.0.11" \
              --add-host "ydb:172.28.0.12" \
              --add-host "ydb:172.28.0.13" \
              --add-host "ydb:172.28.0.99" \
              -e CHECK_INTERVAL=5 \
              -e DURATION=${DURATION} \
              ydb-app-baseline
          else
            echo "No baseline app image found, skipping..."
          fi

          # Show initial logs
          sleep 5
          echo ""
          echo "==================== INITIAL CURRENT LOGS ===================="
          docker logs ydb-app-current 2>&1 || echo "No current container"
          echo ""
          echo "==================== INITIAL BASELINE LOGS ===================="
          docker logs ydb-app-baseline 2>&1 || echo "No baseline container"
          echo ""

          # Wait for containers to finish (they will exit after DURATION)
          echo "Waiting for workloads to complete (${DURATION}s)..."

          # Wait for current container
          if docker ps -q -f name=ydb-app-current | grep -q .; then
            echo "Waiting for ydb-app-current..."
            docker wait ydb-app-current || echo "Current container wait failed"
          fi

          # Wait for baseline container
          if docker ps -q -f name=ydb-app-baseline | grep -q .; then
            echo "Waiting for ydb-app-baseline..."
            docker wait ydb-app-baseline || echo "Baseline container wait failed"
          fi

          echo ""
          echo "==================== FINAL CURRENT LOGS ===================="
          docker logs ydb-app-current 2>&1 || echo "No current container"
          echo ""
          echo "==================== FINAL BASELINE LOGS ===================="
          docker logs ydb-app-baseline 2>&1 || echo "No baseline container"
          echo ""

          # Check exit codes
          CURRENT_EXIT=$(docker inspect ydb-app-current --format='{{.State.ExitCode}}' 2>/dev/null || echo "1")
          BASELINE_EXIT=$(docker inspect ydb-app-baseline --format='{{.State.ExitCode}}' 2>/dev/null || echo "0")

          echo "Current container exit code: $CURRENT_EXIT"
          echo "Baseline container exit code: $BASELINE_EXIT"

          if [ "$CURRENT_EXIT" -ne 0 ]; then
            echo "ERROR: Current workload failed with exit code $CURRENT_EXIT"
            exit 1
          fi

          echo "SUCCESS: Workloads completed successfully"

      - if: always()
        name: Cleanup SLO Database
        run: |
          echo "Cleaning up SLO database..."

          # Stop and remove app containers
          docker stop ydb-app-current ydb-app-baseline 2>/dev/null || true
          docker rm ydb-app-current ydb-app-baseline 2>/dev/null || true

  ydb-slo-post:
    if: (!contains(github.event.pull_request.labels.*.name, 'no slo'))

    name: Generate SLO Summary
    runs-on: ubuntu-latest
    needs: ydb-slo-action

    steps:
      - run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… SLO Tests Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs of the 'Run YDB SLO Tests' job for detailed results." >> $GITHUB_STEP_SUMMARY
