x-runtime: &runtime
  platform: linux/amd64
  networks:
    - ydb-net

x-ydb-node: &ydb-node
  build:
    context: ./ydb
  restart: always
  <<: *runtime
  extra_hosts:
    - "ydb:172.28.0.10"

name: ydb

networks:
  ydb-net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

volumes:
  chaos-events:

services:
  storage-1:
    <<: *ydb-node
    hostname: ydb-storage-1
    container_name: ydb-storage-1
    command: ["--grpc-public-address-v4", "172.28.0.10"]
    networks:
      ydb-net:
        ipv4_address: 172.28.0.10
    labels:
      - ydb.node.type=storage

  database-1:
    <<: *ydb-node
    container_name: ydb-database-1
    command: ["--grpc-public-address-v4", "172.28.0.11"]
    environment:
      - YDB_TENANT=/Root/testdb
      - YDB_ENDPOINT=grpc://ydb:2136
    networks:
      ydb-net:
        ipv4_address: 172.28.0.11
    labels:
      - ydb.node.type=database
    depends_on:
      storage-1:
        condition: service_healthy
      storage-init:
        condition: service_completed_successfully
      database-init:
        condition: service_completed_successfully

  database-2:
    <<: *ydb-node
    container_name: ydb-database-2
    command: ["--grpc-public-address-v4", "172.28.0.12"]
    environment:
      - YDB_TENANT=/Root/testdb
      - YDB_ENDPOINT=grpc://ydb:2136
    networks:
      ydb-net:
        ipv4_address: 172.28.0.12
    labels:
      - ydb.node.type=database
    depends_on:
      storage-1:
        condition: service_healthy
      storage-init:
        condition: service_completed_successfully
      database-init:
        condition: service_completed_successfully

  database-3:
    <<: *ydb-node
    container_name: ydb-database-3
    command: ["--grpc-public-address-v4", "172.28.0.13"]
    environment:
      - YDB_TENANT=/Root/testdb
      - YDB_ENDPOINT=grpc://ydb:2136
    networks:
      ydb-net:
        ipv4_address: 172.28.0.13
    labels:
      - ydb.node.type=database
    depends_on:
      storage-1:
        condition: service_healthy
      storage-init:
        condition: service_completed_successfully
      database-init:
        condition: service_completed_successfully

  database-4:
    <<: *ydb-node
    container_name: ydb-database-4
    command: ["--grpc-public-address-v4", "172.28.0.14"]
    environment:
      - YDB_TENANT=/Root/testdb
      - YDB_ENDPOINT=grpc://ydb:2136
    networks:
      ydb-net:
        ipv4_address: 172.28.0.14
    labels:
      - ydb.node.type=database
    depends_on:
      storage-1:
        condition: service_healthy
      storage-init:
        condition: service_completed_successfully
      database-init:
        condition: service_completed_successfully

  database-5:
    <<: *ydb-node
    container_name: ydb-database-5
    command: ["--grpc-public-address-v4", "172.28.0.15"]
    environment:
      - YDB_TENANT=/Root/testdb
      - YDB_ENDPOINT=grpc://ydb:2136
    networks:
      ydb-net:
        ipv4_address: 172.28.0.15
    labels:
      - ydb.node.type=database
    depends_on:
      storage-1:
        condition: service_healthy
      storage-init:
        condition: service_completed_successfully
      database-init:
        condition: service_completed_successfully

  storage-init:
    <<: *ydb-node
    container_name: ydb-storage-init
    restart: no
    environment:
      - YDB_TENANT=/Root/testdb
      - YDB_ENDPOINT=grpc://ydb:2136
      - YDB_INIT_OPERATION=bootstrap
    depends_on:
      storage-1:
        condition: service_healthy

  database-init:
    <<: *ydb-node
    container_name: ydb-database-init
    restart: no
    environment:
      - YDB_ENDPOINT=grpc://ydb:2136
      - YDB_INIT_OPERATION=create-database
    depends_on:
      storage-1:
        condition: service_healthy
      storage-init:
        condition: service_completed_successfully

  blackhole:
    image: alpine/socat
    container_name: ydb-blackhole
    restart: unless-stopped
    networks:
      ydb-net:
        ipv4_address: 172.28.0.99
    command: tcp-listen:2136,fork,reuseaddr exec:'/bin/cat'
    profiles:
      - chaos
    labels:
      - ydb.node.type=blackhole

  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    <<: *runtime
    container_name: ydb-prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.enable-remote-write-receiver
      - --web.enable-otlp-receiver
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    profiles:
      - telemetry

  chaos-monkey:
    build:
      context: ./chaos
    restart: on-failure
    privileged: true
    <<: *runtime
    container_name: ydb-chaos-monkey
    environment:
      - CHAOS_INITIAL_DELAY=30
      - CHAOS_SCENARIO_DELAY=60
      - CHAOS_EVENTS_FILE=/var/log/chaos-events.jsonl
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - chaos-events:/var/log
    depends_on:
      storage-1:
        condition: service_healthy
      database-1:
        condition: service_healthy
      database-2:
        condition: service_healthy
      database-3:
        condition: service_healthy
      database-4:
        condition: service_healthy
      database-5:
        condition: service_healthy
    profiles:
      - chaos
