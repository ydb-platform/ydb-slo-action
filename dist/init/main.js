import {
  require_github
} from "../main-b9q931vy.js";
import {
  __toESM,
  require_artifact,
  require_core,
  require_exec
} from "../main-h27v9fgs.js";

// init/main.ts
var import_artifact = __toESM(require_artifact(), 1), import_core2 = __toESM(require_core(), 1), import_exec = __toESM(require_exec(), 1);
import * as fs from "node:fs";
import * as path from "node:path";
import { fileURLToPath } from "node:url";

// init/pulls.ts
var import_core = __toESM(require_core(), 1), import_github = __toESM(require_github(), 1);
async function getPullRequestNumber() {
  let token = import_core.getInput("github_token") || process.env.GITHUB_TOKEN, prNumber = import_core.getInput("github_pull_request_number");
  if (prNumber.length > 0)
    return parseInt(prNumber);
  if (import_github.context.eventName === "pull_request")
    return import_github.context.payload.pull_request.number;
  if (token) {
    let octokit = import_github.getOctokit(token), branch = import_github.context.ref.replace("refs/heads/", ""), { data: pulls } = await octokit.rest.pulls.list({
      state: "open",
      owner: import_github.context.repo.owner,
      repo: import_github.context.repo.repo,
      head: `${import_github.context.actor}:${branch}`
    });
    if (pulls.length > 0)
      return pulls[0].number;
  }
  return null;
}

// init/main.ts
async function main() {
  let cwd = path.join(process.cwd(), ".slo"), workload = import_core2.getInput("workload_name") || "unspecified";
  import_core2.saveState("cwd", cwd), import_core2.saveState("workload", workload), fs.mkdirSync(cwd, { recursive: !0 });
  let prNumber = await getPullRequestNumber();
  if (!prNumber) {
    import_core2.setFailed("Pull request number not found");
    return;
  }
  import_core2.saveState("pull", prNumber);
  {
    let pullPath = path.join(cwd, `${workload}-pull.txt`);
    fs.writeFileSync(pullPath, prNumber.toFixed(0), { encoding: "utf-8" });
    let artifactClient = new import_artifact.DefaultArtifactClient, { id } = await artifactClient.uploadArtifact(`${workload}-pull.txt`, [pullPath], cwd, {
      retentionDays: 1
    });
    import_core2.debug(`Pull request information artifact id: ${id}`);
  }
  {
    let actionRoot = path.resolve(path.dirname(fileURLToPath(import.meta.url)), "../../"), deployPath = path.join(actionRoot, "deploy");
    if (!fs.existsSync(deployPath)) {
      import_core2.setFailed(`Deploy assets not found at ${deployPath}`);
      return;
    }
    for (let entry of fs.readdirSync(deployPath)) {
      let src = path.join(deployPath, entry), dest = path.join(cwd, entry);
      fs.cpSync(src, dest, { recursive: !0 });
    }
    import_core2.debug(`Deploy assets copied to ${cwd}`), import_core2.debug(`Deploy assets: ${fs.readdirSync(cwd)}`);
  }
  {
    let metricsFilePath = path.join(cwd, "metrics.jsonl");
    import_core2.saveState("telemetry_metrics_file", metricsFilePath), fs.writeFileSync(metricsFilePath, "", { encoding: "utf-8" }), import_core2.debug(`Telemetry metrics file: ${metricsFilePath}`);
  }
  await import_exec.exec("docker", ["compose", "-f", "compose.yml", "up", "--quiet-pull", "-d"], { cwd });
  let start = /* @__PURE__ */ new Date;
  import_core2.info(`YDB started at ${start}`), import_core2.saveState("start", start.toISOString());
}
main();

//# debugId=3DB573186B4B73D264756E2164756E21
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vaW5pdC9tYWluLnRzIiwgIi4uL2luaXQvcHVsbHMudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbCiAgICAiaW1wb3J0ICogYXMgZnMgZnJvbSAnbm9kZTpmcydcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAnbm9kZTpwYXRoJ1xuaW1wb3J0IHsgZmlsZVVSTFRvUGF0aCB9IGZyb20gJ25vZGU6dXJsJ1xuXG5pbXBvcnQgeyBEZWZhdWx0QXJ0aWZhY3RDbGllbnQgfSBmcm9tICdAYWN0aW9ucy9hcnRpZmFjdCdcbmltcG9ydCB7IGRlYnVnLCBnZXRJbnB1dCwgaW5mbywgc2F2ZVN0YXRlLCBzZXRGYWlsZWQgfSBmcm9tICdAYWN0aW9ucy9jb3JlJ1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ0BhY3Rpb25zL2V4ZWMnXG5cbmltcG9ydCB7IGdldFB1bGxSZXF1ZXN0TnVtYmVyIH0gZnJvbSAnLi9wdWxscy5qcydcblxuYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcblx0bGV0IGN3ZCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAnLnNsbycpXG5cdGxldCB3b3JrbG9hZCA9IGdldElucHV0KCd3b3JrbG9hZF9uYW1lJykgfHwgJ3Vuc3BlY2lmaWVkJ1xuXG5cdHNhdmVTdGF0ZSgnY3dkJywgY3dkKVxuXHRzYXZlU3RhdGUoJ3dvcmtsb2FkJywgd29ya2xvYWQpXG5cblx0LyoqXG5cdCAqIFByZXBhcmUgd29ya2luZyBkaXJlY3Rvcnlcblx0ICovXG5cdHtcblx0XHRmcy5ta2RpclN5bmMoY3dkLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KVxuXHR9XG5cblx0bGV0IHByTnVtYmVyID0gYXdhaXQgZ2V0UHVsbFJlcXVlc3ROdW1iZXIoKVxuXHRpZiAoIXByTnVtYmVyKSB7XG5cdFx0c2V0RmFpbGVkKCdQdWxsIHJlcXVlc3QgbnVtYmVyIG5vdCBmb3VuZCcpXG5cdFx0cmV0dXJuXG5cdH1cblxuXHRzYXZlU3RhdGUoJ3B1bGwnLCBwck51bWJlcilcblxuXHQvKipcblx0ICogUHJlcGFyZSBwdWxsIHJlcXVlc3QgaW5mb3JtYXRpb25cblx0ICovXG5cdHtcblx0XHRsZXQgcHVsbFBhdGggPSBwYXRoLmpvaW4oY3dkLCBgJHt3b3JrbG9hZH0tcHVsbC50eHRgKVxuXHRcdGZzLndyaXRlRmlsZVN5bmMocHVsbFBhdGgsIHByTnVtYmVyLnRvRml4ZWQoMCksIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSlcblx0XHRsZXQgYXJ0aWZhY3RDbGllbnQgPSBuZXcgRGVmYXVsdEFydGlmYWN0Q2xpZW50KClcblx0XHRsZXQgeyBpZCB9ID0gYXdhaXQgYXJ0aWZhY3RDbGllbnQudXBsb2FkQXJ0aWZhY3QoYCR7d29ya2xvYWR9LXB1bGwudHh0YCwgW3B1bGxQYXRoXSwgY3dkLCB7XG5cdFx0XHRyZXRlbnRpb25EYXlzOiAxLFxuXHRcdH0pXG5cblx0XHRkZWJ1ZyhgUHVsbCByZXF1ZXN0IGluZm9ybWF0aW9uIGFydGlmYWN0IGlkOiAke2lkfWApXG5cdH1cblxuXHQvKipcblx0ICogQ29weSBkZXBsb3kgYXNzZXRzXG5cdCAqL1xuXHR7XG5cdFx0Y29uc3QgYWN0aW9uUm9vdCA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUoZmlsZVVSTFRvUGF0aChpbXBvcnQubWV0YS51cmwpKSwgJy4uLy4uLycpXG5cdFx0Y29uc3QgZGVwbG95UGF0aCA9IHBhdGguam9pbihhY3Rpb25Sb290LCAnZGVwbG95JylcblxuXHRcdGlmICghZnMuZXhpc3RzU3luYyhkZXBsb3lQYXRoKSkge1xuXHRcdFx0c2V0RmFpbGVkKGBEZXBsb3kgYXNzZXRzIG5vdCBmb3VuZCBhdCAke2RlcGxveVBhdGh9YClcblx0XHRcdHJldHVyblxuXHRcdH1cblxuXHRcdGZvciAobGV0IGVudHJ5IG9mIGZzLnJlYWRkaXJTeW5jKGRlcGxveVBhdGgpKSB7XG5cdFx0XHRsZXQgc3JjID0gcGF0aC5qb2luKGRlcGxveVBhdGgsIGVudHJ5KVxuXHRcdFx0bGV0IGRlc3QgPSBwYXRoLmpvaW4oY3dkLCBlbnRyeSlcblx0XHRcdGZzLmNwU3luYyhzcmMsIGRlc3QsIHsgcmVjdXJzaXZlOiB0cnVlIH0pXG5cdFx0fVxuXG5cdFx0ZGVidWcoYERlcGxveSBhc3NldHMgY29waWVkIHRvICR7Y3dkfWApXG5cdFx0ZGVidWcoYERlcGxveSBhc3NldHM6ICR7ZnMucmVhZGRpclN5bmMoY3dkKX1gKVxuXHR9XG5cblx0LyoqXG5cdCAqIFByZXBhcmUgdGVsZW1ldHJ5IG1ldHJpY3MgZmlsZVxuXHQgKi9cblx0e1xuXHRcdGxldCBtZXRyaWNzRmlsZVBhdGggPSBwYXRoLmpvaW4oY3dkLCAnbWV0cmljcy5qc29ubCcpXG5cdFx0c2F2ZVN0YXRlKCd0ZWxlbWV0cnlfbWV0cmljc19maWxlJywgbWV0cmljc0ZpbGVQYXRoKVxuXHRcdGZzLndyaXRlRmlsZVN5bmMobWV0cmljc0ZpbGVQYXRoLCAnJywgeyBlbmNvZGluZzogJ3V0Zi04JyB9KVxuXG5cdFx0ZGVidWcoYFRlbGVtZXRyeSBtZXRyaWNzIGZpbGU6ICR7bWV0cmljc0ZpbGVQYXRofWApXG5cdH1cblxuXHQvKipcblx0ICogU3RhcnQgWURCIHNlcnZpY2VzXG5cdCAqL1xuXHR7XG5cdFx0YXdhaXQgZXhlYyhgZG9ja2VyYCwgW2Bjb21wb3NlYCwgYC1mYCwgYGNvbXBvc2UueW1sYCwgYHVwYCwgYC0tcXVpZXQtcHVsbGAsIGAtZGBdLCB7IGN3ZCB9KVxuXHR9XG5cblx0bGV0IHN0YXJ0ID0gbmV3IERhdGUoKVxuXHRpbmZvKGBZREIgc3RhcnRlZCBhdCAke3N0YXJ0fWApXG5cdHNhdmVTdGF0ZSgnc3RhcnQnLCBzdGFydC50b0lTT1N0cmluZygpKVxufVxuXG5tYWluKClcbiIsCiAgICAiaW1wb3J0IHsgZ2V0SW5wdXQgfSBmcm9tICdAYWN0aW9ucy9jb3JlJ1xuaW1wb3J0IHsgY29udGV4dCwgZ2V0T2N0b2tpdCB9IGZyb20gJ0BhY3Rpb25zL2dpdGh1YidcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFB1bGxSZXF1ZXN0TnVtYmVyKCkge1xuXHRsZXQgdG9rZW4gPSBnZXRJbnB1dCgnZ2l0aHViX3Rva2VuJykgfHwgcHJvY2Vzcy5lbnYuR0lUSFVCX1RPS0VOXG5cblx0bGV0IHByTnVtYmVyID0gZ2V0SW5wdXQoJ2dpdGh1Yl9wdWxsX3JlcXVlc3RfbnVtYmVyJylcblx0aWYgKHByTnVtYmVyLmxlbmd0aCA+IDApIHtcblx0XHRyZXR1cm4gcGFyc2VJbnQocHJOdW1iZXIpXG5cdH1cblxuXHRpZiAoY29udGV4dC5ldmVudE5hbWUgPT09ICdwdWxsX3JlcXVlc3QnKSB7XG5cdFx0cmV0dXJuIGNvbnRleHQucGF5bG9hZC5wdWxsX3JlcXVlc3QhLm51bWJlclxuXHR9XG5cblx0aWYgKHRva2VuKSB7XG5cdFx0bGV0IG9jdG9raXQgPSBnZXRPY3Rva2l0KHRva2VuKVxuXHRcdGxldCBicmFuY2ggPSBjb250ZXh0LnJlZi5yZXBsYWNlKCdyZWZzL2hlYWRzLycsICcnKVxuXG5cdFx0Y29uc3QgeyBkYXRhOiBwdWxscyB9ID0gYXdhaXQgb2N0b2tpdC5yZXN0LnB1bGxzLmxpc3Qoe1xuXHRcdFx0c3RhdGU6ICdvcGVuJyxcblx0XHRcdG93bmVyOiBjb250ZXh0LnJlcG8ub3duZXIsXG5cdFx0XHRyZXBvOiBjb250ZXh0LnJlcG8ucmVwbyxcblx0XHRcdGhlYWQ6IGAke2NvbnRleHQuYWN0b3J9OiR7YnJhbmNofWAsXG5cdFx0fSlcblxuXHRcdGlmIChwdWxscy5sZW5ndGggPiAwKSB7XG5cdFx0XHRyZXR1cm4gcHVsbHNbMF0ubnVtYmVyXG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIG51bGxcbn1cbiIKICBdLAogICJtYXBwaW5ncyI6ICI7Ozs7Ozs7Ozs7O0FBSUEsc0RBQ0EsMkNBQ0E7QUFOQTtBQUNBO0FBQ0E7OztBQ0ZBLDhDQUNBO0FBRUEsZUFBc0Isb0JBQW9CLEdBQUc7QUFBQSxFQUM1QyxJQUFJLFFBQVEscUJBQVMsY0FBYyxLQUFLLFFBQVEsSUFBSSxjQUVoRCxXQUFXLHFCQUFTLDRCQUE0QjtBQUFBLEVBQ3BELElBQUksU0FBUyxTQUFTO0FBQUEsSUFD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
