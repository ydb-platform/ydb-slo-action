import { debug, getInput, info } from '@actions/core'
import { context, getOctokit } from '@actions/github'
import type { WorkloadComparison } from '../../shared/analysis.js'
import { evaluateWorkloadThresholds, type ThresholdConfig } from '../../shared/thresholds.js'

export interface CommentReportData {
	workload: string
	thresholds: ThresholdConfig
	comparison: WorkloadComparison
	checkUrl?: string
	reportUrl?: string
}

/**
 * Generate PR comment body
 */
export function generateCommentBody(reports: CommentReportData[]): string {
	let totalFailures = 0
	let totalWarnings = 0

	let rows = reports.map((report) => {
		let evaluation = evaluateWorkloadThresholds(report.comparison.metrics, report.thresholds)

		if (evaluation.overall === 'failure') totalFailures++
		if (evaluation.overall === 'warning') totalWarnings++

		let emoji =
			evaluation.overall === 'failure'
				? 'ðŸ”´'
				: evaluation.overall === 'warning'
					? 'ðŸŸ¡'
					: report.comparison.summary.improvements > 0
						? 'ðŸš€'
						: 'ðŸŸ¢'

		let checkLink = report.checkUrl || '#'
		let reportLink = report.reportUrl || '#'
		let comp = report.comparison

		return `| ${emoji} | ${comp.workload} | ${comp.summary.total} | ${comp.summary.regressions} | ${comp.summary.improvements} | [Report](${reportLink}) â€¢ [Check](${checkLink}) |`
	})

	let statusEmoji = totalFailures > 0 ? 'ðŸ”´' : totalWarnings > 0 ? 'ðŸŸ¡' : 'ðŸŸ¢'
	let statusText =
		totalFailures > 0
			? `${totalFailures} workloads failed`
			: totalWarnings > 0
				? `${totalWarnings} workloads with warnings`
				: 'All passed'

	let header = [
		`## ðŸŒ‹ SLO Test Results`,
		``,
		`**Status**: ${statusEmoji} ${reports.length} workloads tested â€¢ ${statusText}`,
		'',
	].join('\n')

	let content = [
		'| | Workload | Metrics | Regressions | Improvements | Links |',
		'|-|----------|---------|-------------|--------------|-------|',
		...rows,
	]
		.flat()
		.join('\n')

	let footer = `\n---\n*Generated by [ydb-slo-action](https://github.com/ydb-platform/ydb-slo-action)*`

	return header + content + footer
}

/**
 * Find existing comment in PR
 */
export async function findExistingComment(pull: number): Promise<number | null> {
	let token = getInput('github_token')
	let octokit = getOctokit(token)

	info(`Searching for existing SLO comment in PR #${pull}...`)

	let { data: comments } = await octokit.rest.issues.listComments({
		issue_number: pull,
		owner: context.repo.owner,
		repo: context.repo.repo,
	})

	for (let comment of comments) {
		if (comment.body?.includes('ðŸŒ‹ SLO Test Results')) {
			info(`Found existing comment: ${comment.id}`)
			return comment.id
		}
	}

	return null
}

/**
 * Create or update PR comment
 */
export async function createOrUpdateComment(pull: number, body: string): Promise<{ url: string; id: number }> {
	let token = getInput('github_token')
	let octokit = getOctokit(token)

	let existingId = await findExistingComment(pull)

	if (existingId) {
		info(`Updating existing comment ${existingId}...`)

		let { data } = await octokit.rest.issues.updateComment({
			comment_id: existingId,
			owner: context.repo.owner,
			repo: context.repo.repo,
			body,
		})

		debug(`Comment updated: ${data.html_url}`)

		return { url: data.html_url!, id: data.id }
	} else {
		info(`Creating new comment...`)

		let { data } = await octokit.rest.issues.createComment({
			issue_number: pull,
			owner: context.repo.owner,
			repo: context.repo.repo,
			body,
		})

		debug(`Comment created: ${data.html_url}`)

		return { url: data.html_url!, id: data.id }
	}
}
