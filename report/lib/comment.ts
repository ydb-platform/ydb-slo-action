import { debug, getInput, info } from '@actions/core'
import { context, getOctokit } from '@actions/github'
import type { WorkloadComparison } from '../../shared/analysis.js'

/**
 * Generate PR comment body
 */
export function generateCommentBody(
	checkUrls: Map<string, string>,
	reportUrls: Map<string, string>,
	comparisons: WorkloadComparison[]
): string {
	let totalRegressions = comparisons.reduce((sum, w) => sum + w.summary.regressions, 0)
	let totalImprovements = comparisons.reduce((sum, w) => sum + w.summary.improvements, 0)

	let statusEmoji = totalRegressions > 0 ? 'ðŸŸ¡' : totalImprovements > 0 ? 'ðŸŸ¢' : 'âšª'
	let statusText =
		totalRegressions > 0
			? `${totalRegressions} regressions`
			: totalImprovements > 0
				? `${totalImprovements} improvements`
				: 'All clear'

	let header = [
		`## ðŸŒ‹ SLO Test Results`,
		``,
		`**Status**: ${statusEmoji} ${comparisons.length} workloads tested â€¢ ${statusText}`,
		'',
	].join('\n')

	let content = [
		'| | Workload | Metrics | Regressions | Improvements | Links |',
		'|-|----------|---------|-------------|--------------|-------|',
		comparisons.map((comp) => {
			let emoji = comp.summary.regressions > 0 ? 'ðŸŸ¡' : comp.summary.improvements > 0 ? 'ðŸŸ¢' : 'âšª'
			let checkLink = checkUrls.get(comp.workload) || '#'
			let reportLink = reportUrls.get(comp.workload) || '#'

			return `| ${emoji} | ${comp.workload} | ${comp.summary.total} | ${comp.summary.regressions} | ${comp.summary.improvements} | [Report](${reportLink}) â€¢ [Check](${checkLink}) |`
		}),
	]
		.flat()
		.join('\n')

	let footer = `\n---\n*Generated by [ydb-slo-action](https://github.com/ydb-platform/ydb-slo-action)*`

	return header + content + footer
}

/**
 * Find existing comment in PR
 */
export async function findExistingComment(pull: number): Promise<number | null> {
	let token = getInput('github_token')
	let octokit = getOctokit(token)

	info(`Searching for existing SLO comment in PR #${pull}...`)

	let { data: comments } = await octokit.rest.issues.listComments({
		issue_number: pull,
		owner: context.repo.owner,
		repo: context.repo.repo,
	})

	for (let comment of comments) {
		if (comment.body?.includes('ðŸŒ‹ SLO Test Results')) {
			info(`Found existing comment: ${comment.id}`)
			return comment.id
		}
	}

	return null
}

/**
 * Create or update PR comment
 */
export async function createOrUpdateComment(pull: number, body: string): Promise<{ url: string; id: number }> {
	let token = getInput('github_token')
	let octokit = getOctokit(token)

	let existingId = await findExistingComment(pull)

	if (existingId) {
		info(`Updating existing comment ${existingId}...`)

		let { data } = await octokit.rest.issues.updateComment({
			comment_id: existingId,
			owner: context.repo.owner,
			repo: context.repo.repo,
			body,
		})

		debug(`Comment updated: ${data.html_url}`)

		return { url: data.html_url!, id: data.id }
	} else {
		info(`Creating new comment...`)

		let { data } = await octokit.rest.issues.createComment({
			issue_number: pull,
			owner: context.repo.owner,
			repo: context.repo.repo,
			body,
		})

		debug(`Comment created: ${data.html_url}`)

		return { url: data.html_url!, id: data.id }
	}
}
